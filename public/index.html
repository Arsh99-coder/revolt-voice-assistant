<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Revolt Motors - Voice Assistant</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
        }

        .container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            max-width: 500px;
            width: 90%;
        }

        .logo {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #00ff88, #00ccff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            font-size: 1.1rem;
            opacity: 0.8;
            margin-bottom: 30px;
        }

        .voice-interface {
            margin: 30px 0;
        }

        .voice-button {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(45deg, #00ff88, #00ccff);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            box-shadow: 0 4px 20px rgba(0, 255, 136, 0.3);
        }

        .voice-button:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 25px rgba(0, 255, 136, 0.4);
        }

        .voice-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .voice-button.recording {
            animation: pulse 1.5s infinite;
            background: linear-gradient(45deg, #ff4444, #ff6b6b);
            box-shadow: 0 4px 20px rgba(255, 68, 68, 0.3);
        }

        .voice-button.listening {
            animation: listening 2s infinite;
            background: linear-gradient(45deg, #00ff88, #00ccff);
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        @keyframes listening {
            0% { box-shadow: 0 4px 20px rgba(0, 255, 136, 0.3); }
            50% { box-shadow: 0 4px 30px rgba(0, 255, 136, 0.6); }
            100% { box-shadow: 0 4px 20px rgba(0, 255, 136, 0.3); }
        }

        .mic-icon {
            width: 40px;
            height: 40px;
            fill: white;
        }

        .status {
            font-size: 1.1rem;
            margin: 20px 0;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0.9;
        }

        .response-area {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: left;
            font-size: 1rem;
            line-height: 1.5;
        }

        .controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }

        .control-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 25px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .control-btn:hover:not(:disabled) {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .control-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .natural-interruption-info {
            background: rgba(0, 255, 136, 0.1);
            border: 1px solid rgba(0, 255, 136, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            font-size: 0.9rem;
            text-align: center;
        }

        .voice-level-indicator {
            width: 100%;
            height: 4px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
            margin-top: 10px;
            overflow: hidden;
        }

        .voice-level-bar {
            height: 100%;
            background: linear-gradient(90deg, #00ff88, #00ccff);
            width: 0%;
            transition: width 0.1s ease;
        }

        .latency-info {
            font-size: 0.8rem;
            opacity: 0.7;
            margin-top: 10px;
        }

        .error {
            color: #ff6b6b;
            background: rgba(255, 107, 107, 0.1);
            padding: 10px;
            border-radius: 10px;
            margin: 10px 0;
            border: 1px solid rgba(255, 107, 107, 0.3);
        }

        .success {
            color: #00ff88;
            background: rgba(0, 255, 136, 0.1);
            padding: 10px;
            border-radius: 10px;
            margin: 10px 0;
            border: 1px solid rgba(0, 255, 136, 0.3);
        }

        .connection-status {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ff6b6b;
            transition: background 0.3s ease;
        }

        .connection-status.connected {
            background: #00ff88;
        }
    </style>
</head>
<body>
    <div class="connection-status" id="connectionStatus"></div>
    
    <div class="container">
        <div class="logo">REVOLT</div>
        <div class="subtitle">Voice Assistant - Electric Revolution</div>
        
        <div class="voice-interface">
            <button id="voiceButton" class="voice-button" disabled>
                <svg class="mic-icon" viewBox="0 0 24 24">
                    <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/>
                    <path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/>
                </svg>
            </button>
            
            <div id="status" class="status">Connecting to server...</div>
        </div>

        <div id="responseArea" class="response-area">
            Welcome to Revolt Motors! I'm Rev, your voice assistant. I'm here to help you learn about our revolutionary electric motorcycles, the RV400 and RV400 BRZ. Ask me anything about features, pricing, booking, or specifications!
        </div>

        <div class="natural-interruption-info">
            💡 <strong>Natural Conversation:</strong> Just start speaking anytime - I'll automatically stop and listen to you, just like a real conversation!
        </div>

        <div class="controls">
            <button id="startBtn" class="control-btn" disabled>Start Chat</button>
            <button id="endBtn" class="control-btn" disabled>End Chat</button>
        </div>

        <div class="voice-level-indicator">
            <div id="voiceLevelBar" class="voice-level-bar"></div>
        </div>

        <div id="latencyInfo" class="latency-info"></div>
    </div>

    <script>
        class RevoltVoiceAssistant {
            constructor() {
                this.ws = null;
                this.isConnected = false;
                this.isConversationActive = false;
                this.isRecording = false;
                this.aiIsSpeaking = false;
                this.mediaRecorder = null;
                this.audioChunks = [];
                this.audioContext = null;
                this.analyser = null;
                this.microphone = null;
                this.voiceActivityTimer = null;
                this.silenceTimer = null;
                this.reconnectAttempts = 0;
                this.maxReconnectAttempts = 5;
                
                this.initializeElements();
                this.setupEventListeners();
                this.connectWebSocket();
            }

            initializeElements() {
                this.voiceButton = document.getElementById('voiceButton');
                this.status = document.getElementById('status');
                this.responseArea = document.getElementById('responseArea');
                this.startBtn = document.getElementById('startBtn');
                this.endBtn = document.getElementById('endBtn');
                this.latencyInfo = document.getElementById('latencyInfo');
                this.voiceLevelBar = document.getElementById('voiceLevelBar');
                this.connectionStatus = document.getElementById('connectionStatus');
            }

            setupEventListeners() {
                this.voiceButton.addEventListener('click', () => this.handleVoiceButtonClick());
                this.startBtn.addEventListener('click', () => this.startConversation());
                this.endBtn.addEventListener('click', () => this.endConversation());

                // Keyboard shortcuts
                document.addEventListener('keydown', (e) => {
                    if (e.code === 'Space' && e.target === document.body && this.isConversationActive) {
                        e.preventDefault();
                        this.handleVoiceButtonClick();
                    }
                    if (e.key === 'Escape' && this.isRecording) {
                        this.stopRecording();
                    }
                });

                // Handle page unload
                window.addEventListener('beforeunload', () => {
                    this.cleanup();
                });
            }

            connectWebSocket() {
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                // For demo purposes, we'll simulate WebSocket connection
                this.simulateWebSocketConnection();
            }

            simulateWebSocketConnection() {
                // Simulate connection delay
                setTimeout(() => {
                    this.isConnected = true;
                    this.connectionStatus.classList.add('connected');
                    this.updateStatus('Connected to Revolt Motors Assistant');
                    this.startBtn.disabled = false;
                    this.voiceButton.disabled = false;
                    this.reconnectAttempts = 0;
                }, 1000);
            }

            handleWebSocketMessage(data) {
                switch (data.type) {
                    case 'conversation_started':
                        this.isConversationActive = true;
                        this.updateStatus('Conversation started - Click mic or press Space to speak');
                        this.startBtn.disabled = true;
                        this.endBtn.disabled = false;
                        break;

                    case 'ai_response':
                        this.displayResponse(data.text);
                        this.aiIsSpeaking = true;
                        if (data.latency) {
                            this.latencyInfo.textContent = `Response time: ${data.latency}ms`;
                        }
                        this.updateStatus('Rev is speaking - you can interrupt anytime');
                        break;

                    case 'natural_interrupt':
                        this.aiIsSpeaking = false;
                        this.updateStatus('Rev stopped to listen to you');
                        this.stopSpeechSynthesis();
                        break;

                    case 'ai_finished_speaking':
                        this.aiIsSpeaking = false;
                        this.updateStatus('Rev finished speaking - you can ask another question');
                        break;

                    case 'conversation_ended':
                        this.isConversationActive = false;
                        this.updateStatus('Conversation ended');
                        this.startBtn.disabled = false;
                        this.endBtn.disabled = true;
                        this.cleanup();
                        break;

                    case 'error':
                        this.showError(data.message);
                        break;
                }
            }

            async handleVoiceButtonClick() {
                if (!this.isConversationActive) {
                    this.showError('Please start a conversation first');
                    return;
                }

                if (this.isRecording) {
                    this.stopRecording();
                } else {
                    await this.startRecording();
                }
            }

            async startRecording() {
                try {
                    if (this.aiIsSpeaking) {
                        this.stopSpeechSynthesis();
                        this.simulateMessage({ type: 'natural_interrupt' });
                    }

                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        audio: {
                            sampleRate: 16000,
                            channelCount: 1,
                            echoCancellation: true,
                            noiseSuppression: true,
                            autoGainControl: true
                        } 
                    });

                    this.setupAudioAnalyzer(stream);
                    this.setupMediaRecorder(stream);

                    this.mediaRecorder.start();
                    this.isRecording = true;
                    this.voiceButton.classList.add('recording');
                    this.updateStatus('Recording... Click again to stop');

                    // Auto-stop after silence
                    this.setupSilenceDetection();

                } catch (error) {
                    console.error('Error starting recording:', error);
                    this.showError('Failed to access microphone. Please check permissions.');
                }
            }

            setupAudioAnalyzer(stream) {
                this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                this.microphone = this.audioContext.createMediaStreamSource(stream);
                this.analyser = this.audioContext.createAnalyser();
                this.analyser.fftSize = 256;
                this.microphone.connect(this.analyser);

                this.startVoiceLevelMonitoring();
            }

            setupMediaRecorder(stream) {
                // Try different MIME types for better compatibility
                const mimeTypes = [
                    'audio/webm;codecs=opus',
                    'audio/webm',
                    'audio/mp4',
                    'audio/ogg;codecs=opus'
                ];

                let selectedMimeType = null;
                for (const mimeType of mimeTypes) {
                    if (MediaRecorder.isTypeSupported(mimeType)) {
                        selectedMimeType = mimeType;
                        break;
                    }
                }

                if (!selectedMimeType) {
                    throw new Error('No supported audio format found');
                }

                this.mediaRecorder = new MediaRecorder(stream, {
                    mimeType: selectedMimeType
                });

                this.audioChunks = [];

                this.mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        this.audioChunks.push(event.data);
                    }
                };

                this.mediaRecorder.onstop = () => {
                    const audioBlob = new Blob(this.audioChunks, { type: selectedMimeType });
                    this.processAudioData(audioBlob);
                    this.cleanup();
                };

                this.mediaRecorder.onerror = (event) => {
                    console.error('MediaRecorder error:', event.error);
                    this.showError('Recording error occurred');
                    this.cleanup();
                };
            }

            setupSilenceDetection() {
                let silenceStart = null;
                const silenceThreshold = 1500; // 1.5 seconds
                const volumeThreshold = 20;

                const detectSilence = () => {
                    if (!this.isRecording || !this.analyser) return;

                    const dataArray = new Uint8Array(this.analyser.frequencyBinCount);
                    this.analyser.getByteFrequencyData(dataArray);
                    
                    const average = dataArray.reduce((sum, value) => sum + value, 0) / dataArray.length;

                    if (average < volumeThreshold) {
                        if (!silenceStart) {
                            silenceStart = Date.now();
                        } else if (Date.now() - silenceStart > silenceThreshold) {
                            console.log('Auto-stopping recording due to silence');
                            this.stopRecording();
                            return;
                        }
                    } else {
                        silenceStart = null;
                    }

                    if (this.isRecording) {
                        requestAnimationFrame(detectSilence);
                    }
                };

                detectSilence();
            }

            startVoiceLevelMonitoring() {
                const updateVoiceLevel = () => {
                    if (!this.analyser || !this.isRecording) {
                        this.voiceLevelBar.style.width = '0%';
                        return;
                    }

                    const dataArray = new Uint8Array(this.analyser.frequencyBinCount);
                    this.analyser.getByteFrequencyData(dataArray);
                    
                    const average = dataArray.reduce((sum, value) => sum + value, 0) / dataArray.length;
                    const percentage = Math.min((average / 128) * 100, 100);
                    
                    this.voiceLevelBar.style.width = `${percentage}%`;

                    if (this.isRecording) {
                        requestAnimationFrame(updateVoiceLevel);
                    }
                };
                
                updateVoiceLevel();
            }

            stopRecording() {
                if (this.mediaRecorder && this.isRecording) {
                    this.mediaRecorder.stop();
                    this.isRecording = false;
                    this.voiceButton.classList.remove('recording');
                    this.updateStatus('Processing your question...');
                }
            }

            async processAudioData(audioBlob) {
                try {
                    // For demo purposes, simulate AI response
                    this.simulateAIResponse();
                    
                    // In real implementation, send to backend:
                    // const arrayBuffer = await audioBlob.arrayBuffer();
                    // const base64Audio = btoa(String.fromCharCode(...new Uint8Array(arrayBuffer)));
                    // this.sendToBackend(base64Audio);

                } catch (error) {
                    console.error('Error processing audio:', error);
                    this.showError('Failed to process audio data');
                }
            }

            simulateAIResponse() {
                const responses = [
                    "The RV400 BRZ is our latest electric motorcycle with a range of 150km and top speed of 85 km/h. It features a removable battery and smart connectivity.",
                    "Our RV400 comes with a 3.24 KWh lithium-ion battery, disc brakes, and a digital instrument cluster. The price starts at ₹1,38,000.",
                    "You can book a test ride through our website or visit any of our dealerships. We also offer financing options with easy EMIs.",
                    "The RV400 takes about 4 hours for a full charge and has regenerative braking technology for better efficiency."
                ];

                const randomResponse = responses[Math.floor(Math.random() * responses.length)];
                
                setTimeout(() => {
                    this.simulateMessage({
                        type: 'ai_response',
                        text: randomResponse,
                        latency: Math.floor(Math.random() * 500) + 200
                    });
                }, 1000);
            }

            simulateMessage(message) {
                this.handleWebSocketMessage(message);
            }

            async startConversation() {
                if (!this.isConnected) {
                    this.showError('Not connected to server');
                    return;
                }

                try {
                    // Check microphone permission
                    await this.checkMicrophonePermission();
                    
                    // Simulate starting conversation
                    this.simulateMessage({ type: 'conversation_started' });
                    
                    this.updateStatus('Starting conversation...');
                } catch (error) {
                    this.showError('Microphone permission required');
                }
            }

            async checkMicrophonePermission() {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    stream.getTracks().forEach(track => track.stop());
                    return true;
                } catch (error) {
                    throw new Error('Microphone access denied');
                }
            }

            endConversation() {
                this.simulateMessage({ type: 'conversation_ended' });
                this.stopSpeechSynthesis();
            }

            displayResponse(text) {
                this.responseArea.innerHTML = `<div>${text}</div>`;
                
                // Use browser's speech synthesis
                if ('speechSynthesis' in window) {
                    const utterance = new SpeechSynthesisUtterance(text);
                    utterance.rate = 0.9;
                    utterance.pitch = 1;
                    utterance.volume = 0.8;
                    
                    utterance.onstart = () => {
                        this.aiIsSpeaking = true;
                    };
                    
                    utterance.onend = () => {
                        this.simulateMessage({ type: 'ai_finished_speaking' });
                    };
                    
                    speechSynthesis.speak(utterance);
                }
            }

            stopSpeechSynthesis() {
                if ('speechSynthesis' in window) {
                    speechSynthesis.cancel();
                }
                this.aiIsSpeaking = false;
            }

            cleanup() {
                if (this.mediaRecorder && this.mediaRecorder.state !== 'inactive') {
                    this.mediaRecorder.stop();
                }
                
                if (this.audioContext) {
                    this.audioContext.close();
                    this.audioContext = null;
                }
                
                if (this.microphone) {
                    this.microphone.disconnect();
                    this.microphone = null;
                }
                
                this.isRecording = false;
                this.voiceButton.classList.remove('recording', 'listening');
                this.voiceLevelBar.style.width = '0%';
            }

            updateStatus(message) {
                this.status.textContent = message;
            }

            showError(message) {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error';
                errorDiv.textContent = `❌ ${message}`;
                
                // Insert at the top of response area
                this.responseArea.insertBefore(errorDiv, this.responseArea.firstChild);
                
                setTimeout(() => {
                    if (errorDiv.parentNode) {
                        errorDiv.parentNode.removeChild(errorDiv);
                    }
                }, 5000);
            }

            showSuccess(message) {
                const successDiv = document.createElement('div');
                successDiv.className = 'success';
                successDiv.textContent = `✅ ${message}`;
                
                this.responseArea.insertBefore(successDiv, this.responseArea.firstChild);
                
                setTimeout(() => {
                    if (successDiv.parentNode) {
                        successDiv.parentNode.removeChild(successDiv);
                    }
                }, 3000);
            }
        }

        // Initialize the voice assistant when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            // Check for required APIs
            if (!navigator.mediaDevices || !window.MediaRecorder) {
                alert('Your browser does not support the required audio features. Please use a modern browser like Chrome, Firefox, or Safari.');
                return;
            }
            
            new RevoltVoiceAssistant();
        });
    </script>
</body>
</html>